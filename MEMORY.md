# 项目记忆 (Project Memory)

## 2026-02-22
- OpenCode 外部资料核对: PancakeSwap V2 core/periphery + UniswapV2OracleLibrary; 记录 V2 fee 可能为 0.20% (需链上确认)。
- 更新 `技术方案2.txt`: VolatilityOracle 改为 cumulative TWAP；FlashRebalancer 偿还改用 `PancakeLibrary.getAmountsIn`；MEV 增加 ALP minOut；经济模型与附录补充 fee 需确认；标注 Aster 1001x ABI 需 Louper 导出。
- 完成项目根目录检视: 当前仅包含 `MEMORY.md` 与 `技术方案2.txt`，并完成技术方案初步审阅（至第 6 部分）。
- 完成 `技术方案2.txt` 全文审阅与深度分析: 认可 ALP 双重引擎与原子再平衡方向；指出关键风险在波动率/收益假设、bounty 的 gasprice 可操纵、TWAP 采样间隔与初始化、赎回队列激励不足、无管理员下的熔断策略需从“revert”改为“只减仓”。
- 更新 `技术方案2.txt`: 增加 bounty 安全护栏、TWAP 冷启动与采样间隔、ONLY_UNWIND 熔断模式、赎回激励、敏感性/压力测试要求；更新施工任务与附录差异矩阵。
- 新增 `施工计划.MD`: 按 Part1-12 细化验收标准，覆盖 OpenCode 补充项。
- 初始化 Foundry 项目: 生成 `foundry.toml` 并切换 `src = "contracts"`；移除默认 Counter 示例；新增接口 `IAsterDiamond.sol` / `IPancakeRouterV2.sol` / `IPancakePairV2.sol` / `IPancakeFactoryV2.sol` / `IERC20.sol`。
- 拆分文档: 新增 `README.md` / `ARCHITECTURE.md` / `ECONOMICS.md`，并保留 `技术方案2.txt` 原文件。
- 创建 GitHub Issues (Task 0-9): #2-#11 已生成，对应施工任务拆分。
- 新增适配器与脚本: `PancakeV2Adapter` / `AsterAlpAdapter` / `Aster1001xAdapter`；新增 fork 测试骨架与 `ChainChecks.s.sol` / `LouperDump.s.sol`。
- 链上核对完成: 读取 BTCB/USDT V2 Pair 地址与 reserves、ALP 地址、cooldown = 172800；`lastMintedTimestamp()` 在 diamond 上不存在（需 Louper/ABI 对齐）。
- LouperDump 已跑通: 导出 facets 与 selectors（待进一步映射函数签名）。
- Git: 已 `git init` 并两次提交，推送到 `origin/main`。
- Louper selector 映射完成: 新增 `docs/LOUPER_MAP.md`，确认 ALP 与 Trading/Reader 关键签名；Aster ABI 调整为 `uint96/uint80/uint64/uint24` 精度。
- 实现 Task4-6 骨架: `VolatilityOracle` + `EngineVault` + `FlashRebalancer` + `PancakeOracleLibrary/PancakeLibrary/MathLib`；新增对应单测。
- 运行 `forge test` (BSC RPC 最新块): 10 tests 全部通过；旧的固定 block 因非 archive node 报错，已改为不锁定 block。
- 更新文档: `README.md` 增加 Louper 映射索引；`技术方案2.txt` 同步 ABI 与 reader 签名。
- EngineVault 结构重构: 引入 Addresses/Config 参数结构；实现 rebalance/hedge/only-unwind 骨架与 bounty 护栏；增加 WithdrawalQueue 合约与单测。
- README 英文化完成，新增 WithdrawalQueue 与核心合约说明。
- 运行 `forge test` (BSC RPC): 11 tests 全绿。
- 完成 swap/flash/仓位解码: EngineVault 增加 swap 逻辑与 flash 借款量计算；FlashRebalancer 增加 vault 回调；1001x 使用 getPositionsV2(address,address) totalQty 作为对冲基数。
- README 增补 Implementation Notes（swap/flash/reader 说明）。
- 运行 `forge test` (BSC RPC): 11 tests 全绿（无失败）。
- 引入 `ITradingReader.Position` 解码并据此汇总 short qty；EngineVault 调整为 positionHash 批量平仓。
- Flash 回调改为“对端币种偿还”，使用 reserves 计算 repayAmount 并在 vault 内确保兑换补足。
- 新增 `script/ForkCycleDemo.s.sol` 并已运行 fork demo：Shares 与 Regime/TotalAssets 打印成功。
- 运行 `forge test` (BSC RPC): 11 tests 全绿；运行 `forge script script/ForkCycleDemo.s.sol` 成功。
- 修复 LP addLiquidity 最优配比逻辑，避免 PancakeRouter: INSUFFICIENT_A_AMOUNT。
- ForkCycleDemo 已启用外部调用与 LP 配置，swap + addLiquidity 在 fork 上可执行（Hedge 尝试因权限/余额失败）。
- 施工计划更新：标记 M0-M4 完成，补充测试通过与未完成项。
- 运行 `/update_plan`：向用户汇报了当前自动驾驶理财车的进度、通俗比喻以及遗留任务，处于 M2 到 M3 的过渡阶段。
