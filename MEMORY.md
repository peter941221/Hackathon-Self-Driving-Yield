# 项目记忆 (Project Memory)

## 2026-02-22
- OpenCode 外部资料核对: PancakeSwap V2 core/periphery + UniswapV2OracleLibrary; 记录 V2 fee 可能为 0.20% (需链上确认)。
- 更新 `技术方案2.txt`: VolatilityOracle 改为 cumulative TWAP；FlashRebalancer 偿还改用 `PancakeLibrary.getAmountsIn`；MEV 增加 ALP minOut；经济模型与附录补充 fee 需确认；标注 Aster 1001x ABI 需 Louper 导出。
- 完成项目根目录检视: 当前仅包含 `MEMORY.md` 与 `技术方案2.txt`，并完成技术方案初步审阅（至第 6 部分）。
- 完成 `技术方案2.txt` 全文审阅与深度分析: 认可 ALP 双重引擎与原子再平衡方向；指出关键风险在波动率/收益假设、bounty 的 gasprice 可操纵、TWAP 采样间隔与初始化、赎回队列激励不足、无管理员下的熔断策略需从“revert”改为“只减仓”。
- 更新 `技术方案2.txt`: 增加 bounty 安全护栏、TWAP 冷启动与采样间隔、ONLY_UNWIND 熔断模式、赎回激励、敏感性/压力测试要求；更新施工任务与附录差异矩阵。
- 新增 `施工计划.MD`: 按 Part1-12 细化验收标准，覆盖 OpenCode 补充项。
- 初始化 Foundry 项目: 生成 `foundry.toml` 并切换 `src = "contracts"`；移除默认 Counter 示例；新增接口 `IAsterDiamond.sol` / `IPancakeRouterV2.sol` / `IPancakePairV2.sol` / `IPancakeFactoryV2.sol` / `IERC20.sol`。
- 拆分文档: 新增 `README.md` / `ARCHITECTURE.md` / `ECONOMICS.md`，并保留 `技术方案2.txt` 原文件。
- 创建 GitHub Issues (Task 0-9): #2-#11 已生成，对应施工任务拆分。
- 新增适配器与脚本: `PancakeV2Adapter` / `AsterAlpAdapter` / `Aster1001xAdapter`；新增 fork 测试骨架与 `ChainChecks.s.sol` / `LouperDump.s.sol`。
- 链上核对完成: 读取 BTCB/USDT V2 Pair 地址与 reserves、ALP 地址、cooldown = 172800；`lastMintedTimestamp()` 在 diamond 上不存在（需 Louper/ABI 对齐）。
- LouperDump 已跑通: 导出 facets 与 selectors（待进一步映射函数签名）。
- Git: 已 `git init` 并两次提交，推送到 `origin/main`。
- Louper selector 映射完成: 新增 `docs/LOUPER_MAP.md`，确认 ALP 与 Trading/Reader 关键签名；Aster ABI 调整为 `uint96/uint80/uint64/uint24` 精度。
- 实现 Task4-6 骨架: `VolatilityOracle` + `EngineVault` + `FlashRebalancer` + `PancakeOracleLibrary/PancakeLibrary/MathLib`；新增对应单测。
- 运行 `forge test` (BSC RPC 最新块): 10 tests 全部通过；旧的固定 block 因非 archive node 报错，已改为不锁定 block。
- 更新文档: `README.md` 增加 Louper 映射索引；`技术方案2.txt` 同步 ABI 与 reader 签名。
- EngineVault 结构重构: 引入 Addresses/Config 参数结构；实现 rebalance/hedge/only-unwind 骨架与 bounty 护栏；增加 WithdrawalQueue 合约与单测。
- README 英文化完成，新增 WithdrawalQueue 与核心合约说明。
- 运行 `forge test` (BSC RPC): 11 tests 全绿。
- 完成 swap/flash/仓位解码: EngineVault 增加 swap 逻辑与 flash 借款量计算；FlashRebalancer 增加 vault 回调；1001x 使用 getPositionsV2(address,address) totalQty 作为对冲基数。
- README 增补 Implementation Notes（swap/flash/reader 说明）。
- 运行 `forge test` (BSC RPC): 11 tests 全绿（无失败）。
- 引入 `ITradingReader.Position` 解码并据此汇总 short qty；EngineVault 调整为 positionHash 批量平仓。
- Flash 回调改为“对端币种偿还”，使用 reserves 计算 repayAmount 并在 vault 内确保兑换补足。
- 新增 `script/ForkCycleDemo.s.sol` 并已运行 fork demo：Shares 与 Regime/TotalAssets 打印成功。
- 运行 `forge test` (BSC RPC): 11 tests 全绿；运行 `forge script script/ForkCycleDemo.s.sol` 成功。
- 修复 LP addLiquidity 最优配比逻辑，避免 PancakeRouter: INSUFFICIENT_A_AMOUNT。
- ForkCycleDemo 已启用外部调用与 LP 配置，swap + addLiquidity 在 fork 上可执行（Hedge 尝试因权限/余额失败）。
- 施工计划更新：标记 M0-M4 完成，补充测试通过与未完成项。
- 新增 `THREAT_MODEL.md` 威胁建模文档；README 增加文档索引与不变量测试命令。
- 新增 `test/Invariant.t.sol` 并通过不变量测试；施工计划 Part10/Part11 同步更新。
- 新增 `test/EngineVaultRiskMode.t.sol`，覆盖 ONLY_UNWIND 负向测试；README 增加负向测试命令。
- 完成经济模型增强: `ECONOMICS.md` 增加输入/公式/敏感性输出模板；新增 `docs/DEMO_SCRIPT.md`。
- 代码质量: 运行 slither (排除依赖) 与 forge test/format；修复 unchecked transfer 与 reentrancy guard；仍有 timestamp/strict equality 等 warnings。
- 新增 `docs/DEMO_SCRIPT.md` 与 `ECONOMICS.md` 公式/模板扩展；THREAT_MODEL 更新 reentrancy 说明。
- 添加 nonReentrant 到 EngineVault/WithdrawalQueue 与 transfer/approve require；Slither 仍有 divide-before-multiply / strict equality / timestamp 等警告。
- 运行 `/update_plan`：向用户汇报了当前自动驾驶理财车的进度、通俗比喻以及遗留任务，处于 M2 到 M3 的过渡阶段。

## 2026-02-23
- 恢复项目记忆: 已读取 `MEMORY.md` 并开始新会话。
- 梳理 `施工计划.MD` 未完成项: M5/M6、Part1-3、Part10 fork A-F、Part11、Task 8-9、附录 A-C。
- README 增加 Design Philosophy + Hackathon Pillars，补足 Why/What/How/Assumptions/Sustainability/Resilience。
- 运行 `forge test`: 11 passed, 2 failed (ZERO_PAIR in Invariant + RiskMode)。
- 修复 ZERO_PAIR: 新增 `test/MockPancakePair.sol`，更新 `test/Invariant.t.sol` / `test/EngineVaultRiskMode.t.sol` 使用 mock pair。
- 新增 fork 测试 A-F: `test/ForkSuite.t.sol`。
- 新增 `docs/ANALYSIS.md` 与 `docs/ONCHAIN_CHECKS.md`，README 文档索引同步。
- 运行 `forge test`: 20 tests passed, 0 failed。
- 运行 fork 测试 (BSC RPC): ForkSuite + Adapter tests 全绿。
- 运行 `forge script script/ChainChecks.s.sol`: 记录 pair/reserves/ALP/cooldown。
- 更新 `施工计划.MD`: Part1-3、Part10、Task8、附录 A/C 标记完成，Part4 链上核对标记完成 (fee 仍待确认)。
- 通过 `cast call` 确认 Pancake V2 `INIT_CODE_PAIR_HASH` 并写入 `docs/ONCHAIN_CHECKS.md` / `技术方案2.txt`。
- Pancake V2 fee 由核心合约公式确认 0.20%，同步更新 `ECONOMICS.md` 与 `技术方案2.txt`。
- 更新 `docs/DEMO_SCRIPT.md`，补充 fork suite 命令与最新输出。
- 测试警告清理: 将多处测试函数标注为 `view/pure`。
- 运行 `forge test`: 20 tests passed, 0 failed (无编译 warnings)。
- 重新运行 fork suite: `forge test --match-path test/ForkSuite.t.sol` 全绿。
- 新增 `docs/SUBMISSION_CHECKLIST.md` (DoraHacks 提交清单)。
- README 补充 on-chain verification / static analysis / submission 说明并加入新文档索引。
- 运行 `slither . --exclude-dependencies`，更新 `docs/SLITHER_NOTES.md` (记录所有 warnings 与理由)。
- 更新 `docs/ONCHAIN_CHECKS.md` 增加 INIT_CODE_PAIR_HASH 与 fee 说明 + 参考链接。
- 更新 `ECONOMICS.md` 与 `技术方案2.txt`：确认 Pancake V2 fee = 0.20% + INIT_CODE_HASH。
- 更新 `施工计划.MD`：slither 已运行，记录 warnings。
- 运行 `forge test` 再次确认 20 tests 全绿。
- 完善 README (英文) 与提交清单；提交并推送至 `origin/main`。
- 进行全量代码/文档检视并评估竞赛胜率: 结构与测试完整度高, 主要缺口在 Demo 视频与部分中文文档, 另有 oracle deviation 使用 spot 的潜在风险提示。
- 文档英文化: 重写 `ARCHITECTURE.md` / `ECONOMICS.md` / `docs/ANALYSIS.md` / `docs/ONCHAIN_CHECKS.md`。
- Oracle 偏差修复: VolatilityOracle 新增 `getTwapPrice1e18()`；EngineVault 使用 TWAP 对比 spot 触发偏差熔断。
- 新增 `test/VolatilityOracle.t.sol` 覆盖 TWAP 输出；`forge test` 21 tests 全绿。
- 归档并忽略 `技术方案2.txt` / `施工计划.MD`: 移至 `archive/` 并添加 `.gitignore`；README 和 demo storyboard 去除引用。
- 新增 `test/FlashAccounting.t.sol` 覆盖 flash 借入资产扣减；`forge test` 23 tests 全绿。
- 新增 `testPriceDeviationTriggersOnlyUnwind`，验证 TWAP vs spot 偏差触发 ONLY_UNWIND。
- 更新 `MockPair` 以支持 LP balance/totalSupply 读取，避免测试回滚。
- Slither 采用 CLI exclude 列表 (见 README/SLITHER_NOTES) 并清零 warnings。
- 英文化补全 ECONOMICS 模板示例输出，THREAT_MODEL 更新 gap 描述。
- 经济校准: 引入 Dexscreener + DeFiLlama + on-chain ALP price 数据，更新 `ECONOMICS.md` 与 `docs/ONCHAIN_CHECKS.md`。
- Slither 短板收敛: 通过 inline 注释与 CLI exclude 精简到 5 项，运行结果 0 warnings。
- 评估题目达成度: 四大支柱 (Integrate/Stack/Automate/Protect) 有代码与文档证据链, 结论为“结构性达成”, Demo 仍是官方硬性材料。
- 更新 README 状态措辞并新增 Testnet 部署说明。
- 修复代码质量问题: EngineVault 清理死代码并新增 UnwindForWithdraw 事件, Aster1001xAdapter 增加 uint96 边界检查, IAsterDiamond 注释改为最小接口说明。
- 新增 5 组测试: `test/CycleFullPath.t.sol` / `test/FlashRebalanceFull.t.sol` / `test/BountyEdgeCases.t.sol` / `test/WithdrawalQueueEdge.t.sol` / `test/OracleEdgeCases.t.sol`, 以及 `test/MockERC20.sol`。
- 新增 `scripts/backtest.py` 并用 CoinGecko 90 天数据生成回测输出, 更新 `ECONOMICS.md` 回测结果。
- 新增 `script/Deploy.s.sol` 用于 BSC Testnet 部署脚本。
- 修复新增测试的 mock 逻辑与退化场景, `forge test` 40/40 通过。
- BSC Testnet 已领取 0.3 tBNB 并确认到账, faucet tx: 0xab808b8974fa67593d6842a8b61639f84dbd2949993954f9b91900d6d5dfa6e7。
- 新增根目录部署输入模板: `DEPLOYMENT_INPUTS.md` (用于填写部署参数, 私钥不写入)。

## 2026-02-23 (续)
- 恢复项目记忆，解读 `DEPLOYMENT_INPUTS.md` 填写指南。
- 链上查询 BSC Testnet 交易对: BTCB/USDT 和 WBNB/USDT 均不存在；WBNB/BUSD 存在且有流动性。
- 分析部署策略: 方案 A (测试网部署) vs 方案 B (Fork 主网测试)，结论选 B。
  - 理由: Aster ALP 和 1001x 仅在 BSC 主网，测试网无法演示核心功能。
- 更新 `DEPLOYMENT_INPUTS.md`: 标注选择 Fork BSC 主网方案，保留测试网信息备用。
- 运行 `forge test`: 39/40 通过，1 失败 (testForkC_AsterAlpPriceReadable)。
  - 失败原因: 公开 RPC 非 archive node，无法读取历史区块存储，非代码问题。
- 梳理剩余任务: Demo 视频 (必需) + DoraHacks 提交表单。
- **规则确认**: 以后会话进度自动更新 MEMORY.md。

## 2026-02-23 (提交准备)
- 全面检视项目竞争力: 技术完整度高，主要缺口在Demo视频。
- 优化 `docs/DORAHACKS_SUBMISSION.md`: 增加ASCII艺术、表格、创新亮点强调。
- 更新 `docs/DEMO_STORYBOARD.md`: 增加详细的画面指导、台词、录制技巧。
- 验证Demo命令:
  - `forge test` → 40/40 通过 (含invariant测试)
  - `forge script script/ForkCycleDemo.s.sol` → 成功输出 Shares/Regime/TotalAssets
- 剩余任务: 录制Demo视频 + 填写DoraHacks表单。
